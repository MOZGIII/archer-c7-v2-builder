#!/bin/bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")/.."
DIR="$(pwd)"

BUILDER_IMAGE="mozgiii/openwrt-image-builder"

ENV_VARS=( "${!BUILDER_@}" )

ARGS=(
  "--rm"
  "-it"
  "--net=host"
  "--mount" "type=bind,source=$DIR/build,target=/build"
  "--mount" "type=bind,source=$DIR,target=/builder,readonly"
)

for env_var in "${ENV_VARS[@]}"; do
  ARGS+=( "--env" "$env_var" )
done

if [[ "${WORKDIR:-}" != "" ]]; then
  ARGS+=("-w" "$WORKDIR")
fi

mkdir -p build
docker run \
  "${ARGS[@]}" \
  "$BUILDER_IMAGE" \
  "$@"
