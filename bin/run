#!/bin/bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")/.."
DIR="$(pwd)"

ENV_VARS=( "${!BUILD_CFG_@}" )

BUILDER_IMAGE="${BUILDER_IMAGE:-"mozgiii/openwrt-image-builder"}"

ARGS=(
  "--rm"
  "-it"
  "--net=host"
  "--mount" "type=bind,source=$DIR/build,target=/build"
  "--mount" "type=bind,source=$DIR,target=/builder,readonly"
)

for env_var in "${ENV_VARS[@]}"; do
  ARGS+=( "--env" "$env_var" )
done

if [[ -n "${WORKDIR:-}" ]]; then
  ARGS+=( "-w" "$WORKDIR" )
fi

mkdir -p build
set -x
docker run \
  "${ARGS[@]}" \
  "$BUILDER_IMAGE" \
  "$@"
